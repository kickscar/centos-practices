06. PostgreSQL

1. 의존성 라이브러리 설치
```bash
# yum -y install readline-devel.x86_64 python-devel
```


2. postgres 계정 만들기
```bash
# groupadd postgres
# adduser -M -g postgres postgres
```

	
3. 다운로드
https://www.postgresql.org/ftp/source/v12.5/



4. 빌드 환경
```bash
# ./configure --prefix=/usr/local/kickscar/pgsql --with-python --with-openssl --enable-nls=ko
```


5. 빌드 및 설치
```bash
# make && make install
```


6. 설치 디렉토리 및 파일 소유자 변경
```bash
# chown -R postgres:postgres /usr/local/kickscar/pgsql
```


7. 환경설정
```bash
# vi /etc/profile
```

============================================
```sh
# postgres
export POSTGRES_HOME=/usr/local/kickscar/pgsql
export PGLIB=$POSTGRES_HOME/lib
export PGDATA=$POSTGRES_HOME/data
export PATH=$PATH:$POSTGRES_HOME/bin
```
============================================



8. 기본 database 생성
```bash
# sudo -u postgres /usr/local/kickscar/pgsql/bin/initdb -E UTF8 --locale=ko_KR.UTF-8 /usr/local/kickscar/pgsql/data
```


9. 실행
```bash
# sudo -u postgres /usr/local/kickscar/pgsql/bin/pg_ctl -D /usr/local/kickscar/pgsql/data -l /usr/local/kickscar/pgsql/data/logfile start
```



10. 비밀번호 설정
```bash
# psql -U posgres

postgres=# alter user postgres with password 'postgres';
postgres=# \q

# vi /usr/local/kickscar/pgsql/data/pg_hba.conf
```

========================================================================================
```conf
# TYPE  DATABASE        USER            ADDRESS                 METHOD

# "local" is for Unix domain socket connections only
local   all             psotgres                                password
```
========================================================================================




11. 서비스 등록
```bash
# vi /usr/lib/systemd/system/postgres.service
```

========================================================================================
```service
# Systemd service definition for postgresql-bdr94
# 
# It's not recommended to modify this file in-place, because it will be
# overwritten during package upgrades.  If you want to customize, the
# best way is to create a file "/etc/systemd/system/postgresql-9.4.service",
# containing
#   .include /lib/systemd/system/postgresql-9.4.service
#   ...make your changes here...
# For more info about custom unit files, see
# http://fedoraproject.org/wiki/Systemd#How_do_I_customize_a_unit_file.2F_add_a_custom_unit_file.3F

# Note: changing PGDATA will typically require adjusting SELinux
# configuration as well.

# Note: do not use a PGDATA pathname containing spaces, or you will
# break postgresql-setup.
[Unit]
Description=PostgreSQL 12.5 database server with BDR
After=syslog.target
After=network.target

[Service]
Type=forking

User=postgres
Group=postgres

# Note: avoid inserting whitespace in these Environment= lines, or you may
# break postgresql-setup.

# Location of database directory
Environment=PGDATA=/usr/local/kickscar/pgsql/data

# Where to send early-startup messages from the server (before the logging
# options of postgresql.conf take effect)
# This is normally controlled by the global default set by systemd
# StandardOutput=syslog

# Disable OOM kill on the postmaster
OOMScoreAdjust=-1000

ExecStart=/usr/local/kickscar/pgsql/bin/pg_ctl start -D "${PGDATA}" -s -w -t 300
ExecStop=/usr/local/kickscar/pgsql/bin/pg_ctl stop -D "${PGDATA}" -s -m fast
ExecReload=/usr/local/kickscar/pgsql/bin/pg_ctl reload -D "${PGDATA}" -s

# Give a reasonable amount of time for the server to start up/shut down
TimeoutSec=300

[Install]
WantedBy=multi-user.target
```
========================================================================================

```bash
# systemctl enable postgres
# systemctl start postgres
# systemctl status postgres
```



11. 기본 명령어 연습하기

1) 버젼 확인:
```bash
postgres=# select version();
```

2) 도움말:
```bash
postgres=# \?
```

3) shell 명령어:
```bash
postgres=# \! command
```

4) 종료:
```bash
postgres=# \q
```

5) webdb 데이터베이스 생성
```bash
postgres=# create database webdb;
postgres=# \l
postgres=# \c webdb
postgres=# \dt
```

6) 테이블 생성
```bash
webdb=# create table pet(
webdb(# name varchar(20), 
webdb(# owner varchar(20),
webdb(# species varchar(20),
webdb(# gender char(1),
webdb(# birth date,
webdb(# death date);
webdb=# \d pet
```

7) 테이블 삭제
```bash
webdb=# drop table pet;
```

8) 사용자 생성
```bash
postgres=# create user webdb with password 'webdb';
```

9) 권한부여
```bash
postgres=# grant all privileges on all tables in schema public to webdb;
postgres=# \dn
```

10) 연결 설정
```bash
# vi /usr/local/kickscar/pgsql/pg_hba.conf
```

========================================================================================
```conf
# TYPE  DATABASE        USER            ADDRESS                 METHOD

# "local" is for Unix domain socket connections only
local   webdb           webdb                                   password
```
========================================================================================


11) 테이블 소유자 변경
```bash
postgres=# alter table pet owner to webdb;
```

12) 외부 연결
```bash
vi /cafe24/pgsql/data/postgresql.conf
```

========================================================================================
```conf
listen_addresses = '*'
```
========================================================================================





